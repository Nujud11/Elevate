{% extends "website/base_site.html" %}
{% load static wagtailimages_tags %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">

  <header class="company-header-strip">
      <div class="flex items-center space-x-4 mb-8">
          <div class="h-16 w-16 rounded-full overflow-hidden flex items-center justify-center bg-accent text-3xl font-bold text-brand flex-shrink-0">
              {% if request.user.profile.avatar %}
                  <img src="{{ request.user.profile.avatar.url }}"
                       alt="{{ request.user.username }} avatar"
                       class="h-full w-full object-cover">
              {% else %}
                  {{ request.user.username|slice:":1"|upper }}
              {% endif %}
          </div>
          <h1 class="text-ink text-4xl font-extrabold">{{ request.user.username }}</h1>
      </div>

      <a href="{% url 'company_create' %}" class="add-internship-banner block">
          + Add New Internship
      </a>
  </header>

    <form action="." method="GET" id="search-form" class="mb-8 max-w-3xl mx-auto">
        {% csrf_token %}
        <div class="flex gap-2 items-center">
            <div class="flex-1 relative">
                <label for="id_q" class="sr-only">Enter title</label>
                <input type="search" name="q" id="id_q" value="{{ request.GET.q|default:'' }}"
                       class="w-full p-3 pl-10 border-2 border-line rounded-md focus:ring-brand focus:border-brand"
                       placeholder="Enter title">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <button type="submit" class="btn btn-primary btn-sm px-6">Search</button>
            <input type="hidden" name="remote_filter" value="{{ request.GET.remote_filter|default:'' }}">
        </div>
    </form>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div class="flex items-center gap-4 mb-4 md:mb-0">
            <h3 class="font-bold text-ink text-lg">Filter</h3>
            <div class="relative">
                <select name="remote_filter_display" onchange="updateHiddenFilter(this.value);"
                        class="appearance-none bg-bg-soft border border-line rounded-md p-2 pr-8 text-sm text-ink">
                    <option value="" {% if not request.GET.remote_filter %}selected{% endif %}>All Opportunities</option>
                    <option value="1" {% if request.GET.remote_filter == "1" %}selected{% endif %}>Remote Only</option>
                    <option value="0" {% if request.GET.remote_filter == "0" %}selected{% endif %}>On-Site Only</option>
                </select>
                <svg class="absolute right-2 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>
        <h3 class="text-ink text-xl font-semibold">
          All Internships (<span class="text-brand">{{ total_count|default:"0" }}</span>)
        </h3>
    </div>

    {% if internships %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for job in internships %}
        <div class="card flex flex-col justify-between">
          <div>
              <div class="flex justify-between items-start mb-2">
                  <h4 class="text-lg font-semibold text-ink leading-tight pr-2">{{ job.title }}</h4>
                  <span class="{% if job.is_remote %}badge-remote{% else %}badge-onsite{% endif %} flex-shrink-0">
                      {% if job.is_remote %}REMOTE{% else %}ON-SITE{% endif %}
                  </span>
              </div>

              <div class="flex items-center space-x-3 mb-3">
                  <div class="h-8 w-8 rounded-full overflow-hidden flex items-center justify-center bg-line text-xs font-bold text-muted flex-shrink-0">
                    {% with owner_profile=job.owner.profile %} {# Get profile once #}
                        {% if job.logo %}
                            {# 1. Use job-specific logo if available #}
                            {% image job.logo width-32 height-32 as company_logo %}
                            <img src="{{ company_logo.url }}" class="h-full w-full object-contain" alt="{{ job.owner.username }} logo">
                        {% elif owner_profile.avatar %}
                            {# 2. Use company profile avatar if job logo is missing #}
                            <img src="{{ owner_profile.avatar.url }}" class="h-full w-full object-cover" alt="{{ job.owner.username }} avatar">
                        {% else %}
                            {# 3. Fallback to initials if neither logo exists #}
                            {{ job.owner.username|slice:":1"|upper }}
                        {% endif %}
                    {% endwith %}
                  </div>

                  <div class="flex flex-col">
                      <p class="text-sm font-medium text-ink">{{ job.owner.username }}</p>
                      <p class="text-sm text-muted">{{ job.location }}</p>
                  </div>
              </div>

              <div class="pt-2 border-t border-line/50">
                  <p class="text-sm text-muted font-medium mb-1">
                    + {{ job.applicant_count|default:"0" }} applicants
                  </p>
                  <p class="text-sm text-ink leading-relaxed">
                      {{ job.requirements }}
                  </p>
              </div>
          </div>
          <div class="flex space-x-3 mt-4">
              <a href="{% url 'company_edit' pk=job.pk %}" class="btn btn-ghost flex-1 btn-sm">Edit</a>
              <a href="{% url 'company_applications' pk=job.pk %}" class="btn btn-primary flex-1 btn-sm">View Applicants</a>
          </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 bg-bg-soft rounded-lg border border-line">
        <p class="text-xl text-ink font-semibold mb-2">You haven't posted any internships yet.</p>
        <p class="text-muted">Click "+ Add New Internship" above to get started.</p>
    </div>
    {% endif %}

    {% if page_obj.has_other_pages %}
    <div class="flex justify-center mt-12 space-x-4 text-brand font-medium">
        {% with q=request.GET.q|default:"" remote_filter=request.GET.remote_filter|default:"" %}
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&remote_filter={{ remote_filter|urlencode }}" class="hover:text-accent">previous</a>
        {% endif %}
        <span class="text-muted">|</span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&remote_filter={{ remote_filter|urlencode }}" class="hover:text-accent">next</a>
        {% endif %}
        {% endwith %}
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
    function updateHiddenFilter(value) {
        document.querySelector('#search-form input[name="remote_filter"]').value = value;
        document.getElementById('search-form').submit();
    }
</script>
{% endblock extra_js %}
{% endblock content %}